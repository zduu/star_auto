# Discourse网站自动化脚本

这个脚本可以自动化访问各种基于Discourse架构的网站，支持多网站配置、手动登录后保存登录状态，并实现随机浏览帖子、点赞和滚动观看的功能。

## 功能特性

- ✅ **跨平台支持** - 完全兼容Mac、Windows和Linux平台
- ✅ **多网站支持** - 支持配置多个Discourse网站
- ✅ **Cloudflare绕过** - 使用undetected_chromedriver绕过人机验证
- ✅ **有头/无头模式** - 可选择显示浏览器界面或后台运行
- ✅ **智能登录管理** - 手动登录后自动保存登录状态
- ✅ **登录重定向处理** - 支持复杂的登录流程（如SJTU的jaccount）
- ✅ **双模式浏览** - 支持随机浏览模式和直接链接模式
  - **随机浏览模式** - 随机选择主页帖子进行浏览
  - **直接链接模式** - 直接输入主楼链接进行浏览和点赞
- ✅ **智能动态加载** - 自动等待页面动态内容加载，适应超长帖子
- ✅ **智能点赞系统** - 滚动过程中对所有可见帖子进行点赞，支持开关控制
- ✅ **真实用户模拟** - 模拟真实用户滚动浏览所有回复
- ✅ **完整的日志记录** - 详细的操作日志和错误追踪
- ✅ **配置管理工具** - 图形化配置管理界面

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

### 快速开始

#### Windows用户
1. **双击启动**：双击 `start.bat` 文件
2. **命令行启动**：
   ```cmd
   python start.py
   ```

#### Mac/Linux用户
1. **脚本启动**：
   ```bash
   ./start.sh
   ```
2. **命令行启动**：
   ```bash
   python start.py
   ```

#### 其他功能
1. **管理网站配置**：
   ```bash
   python manage_sites.py
   ```

2. **直接运行主脚本**：
   ```bash
   python shuiyuan_automation.py
   ```


### 详细步骤

1. **配置网站**（首次使用）：
   - 运行 `python manage_sites.py` 管理网站配置
   - 或直接编辑 `sites_config.json` 文件
   - 默认已包含水源社区配置

2. **运行自动化**：
   - 运行 `python start.py`
   - 选择要访问的网站
   - 选择运行模式：
     - **随机浏览模式**：随机选择主页帖子进行浏览
     - **直接链接模式**：直接输入主楼链接进行浏览
   - 选择有头/无头模式
   - 设置循环次数（直接链接模式自动设为1次）
   - 脚本会自动检查并安装依赖

3. **首次登录**：
   - 脚本会自动打开Chrome浏览器
   - 访问选定的网站主页
   - 如果未登录，请在浏览器中手动完成登录
   - 登录完成后脚本会自动继续执行

4. **后续使用**：
   - 脚本会检测到已保存的登录状态
   - 直接开始自动化浏览流程

5. **登录状态管理**：
   - 每个网站的登录信息保存在独立的用户数据目录
   - 如需重新登录，删除对应的 `chrome_user_data_*` 目录即可

## 工作流程

1. **启动和登录检查**
   - 启动Chrome浏览器（使用独立的用户数据目录）
   - 访问选定的网站主页
   - 检查登录状态

2. **自动化浏览**

   **随机浏览模式**：
   - 在主页随机选择一个帖子
   - 点击进入帖子详情页
   - 从上到下滚动浏览所有内容
   - **在滚动过程中对所有可见的帖子进行点赞**（包括主楼和回复）
   - 返回主页准备下一个循环

   **直接链接模式**：
   - 直接访问用户提供的主楼链接
   - 从上到下滚动浏览所有内容
   - **在滚动过程中对所有可见的帖子进行点赞**（包括主楼和回复）
   - 浏览完成后结束程序

3. **智能点赞系统**
   - 检测当前视窗内的所有点赞按钮
   - **简化防重复机制**：位置记录 + 基础状态检测
   - 基于按钮位置避免重复点击，防止取消点赞
   - 只检测最明显的已点赞标识，减少误判
   - 可通过开关控制是否启用点赞

4. **智能行为模拟**
   - 随机的滚动速度和停留时间
   - 模拟真实用户的阅读行为
   - 点赞间隔和循环间的随机等待时间

## 配置选项

### 网站配置
- **多网站支持**：在 `sites_config.json` 中配置多个网站
- **自定义选择器**：为每个网站配置专用的CSS选择器
- **独立用户数据**：每个网站使用独立的登录状态存储

### 运行选项
- **循环次数**：指定要执行的浏览循环次数
- **浏览器模式**：选择有头模式（显示界面）或无头模式（后台运行）
- **日志记录**：每个网站生成独立的日志文件

### 添加新网站
1. 使用 `python manage_sites.py` 图形化添加
2. 或手动编辑 `sites_config.json`：
   ```json
   {
     "sites": {
       "mysite": {
         "name": "我的网站",
         "base_url": "https://mysite.com",
         "login_url": "https://login.mysite.com",
         "like_selectors": [".like-button", ".post-controls .like"],
         "topic_selectors": ["a.title", ".topic-list-item a.title"],
         "user_data_dir": "chrome_user_data_mysite"
       }
     }
   }
   ```

## 注意事项

1. **首次运行**需要手动登录，之后会自动保持登录状态
2. **Chrome浏览器**会自动下载和配置ChromeDriver
3. **登录状态**保存在本地，重启脚本后仍然有效
4. **请遵守网站使用条款**，合理使用自动化功能
5. **建议设置合理的循环次数**，避免对服务器造成过大压力

## 故障排除

### 常见问题

- **登录失败**：清除`chrome_user_data`目录重新登录
- **找不到元素**：网站可能更新了页面结构，需要更新选择器
- **Chrome启动失败**：确保系统已安装Chrome浏览器

### 无头模式问题
- **无头模式找不到帖子**：已优化页面加载等待时间和选择器匹配
- **动态内容加载**：无头模式会自动等待更长时间以确保内容加载完成

### 浏览器清理问题
- **程序退出后浏览器未关闭**：已添加信号处理和自动清理机制
- **手动清理残留进程**：运行 `python cleanup_browsers.py`

### 点赞功能问题
- **无法自动点赞**：已为linux.do等网站优化选择器配置
- **调试点赞问题**：启用调试日志查看详细的按钮查找信息

### 测试工具
- **测试linux.do功能**：`python test_linux_do.py`
- **清理浏览器进程**：`python cleanup_browsers.py`
- **快速功能测试**：`python quick_test.py`

## 文件说明

### 核心文件
- `shuiyuan_automation.py` - 主要的自动化脚本
- `start.py` - 用户友好的启动器脚本
- `platform_utils.py` - 平台兼容性工具模块
- `manage_sites.py` - 网站配置管理工具
- `sites_config.json` - 网站配置文件
- `requirements.txt` - Python依赖包列表

### 运行时生成
- `*_automation.log` - 各网站的运行日志文件
- `chrome_user_data_*/` - 各网站的Chrome用户数据目录

### 文档
- `README.md` - 使用说明文档

## 平台兼容性

### 支持的操作系统
- ✅ **Windows** (Windows 10/11)
- ✅ **macOS** (macOS 10.14+)
- ✅ **Linux** (Ubuntu, CentOS, Debian等)

### 平台特定功能
- **自动Chrome路径检测** - 自动找到不同平台的Chrome安装路径
- **平台特定Chrome选项** - 针对不同平台优化的浏览器选项
- **安全文件名处理** - 自动处理不同平台的文件名限制
- **用户数据目录管理** - 跨平台的用户数据存储
- **依赖检查** - 平台特定的依赖和环境检查


## 技术实现

- **undetected_chromedriver** - 绕过Cloudflare人机验证的Chrome驱动
- **Selenium WebDriver** - 浏览器自动化
- **Chrome WebDriver** - Chrome浏览器驱动（备用方案）
- **webdriver-manager** - 自动管理ChromeDriver版本
- **平台检测** - 自动检测操作系统并适配
- **随机化策略** - 模拟真实用户行为
- **持久化登录** - 使用Chrome用户数据目录
- **动态加载处理** - 智能等待页面内容加载

## Cloudflare绕过功能

本脚本使用`undetected_chromedriver`来绕过Cloudflare的人机验证：

### 主要特性
- **自动检测绕过** - 自动处理"Checking your browser"页面
- **隐藏自动化特征** - 移除webdriver属性和自动化标识
- **真实浏览器模拟** - 使用真实的Chrome浏览器指纹
- **智能重试机制** - 如果undetected_chromedriver失败，自动回退到传统方式`

### 注意事项
- 某些网站可能仍然需要手动验证
- 建议在首次访问时保持有头模式以观察验证过程
- 如遇到问题，脚本会自动回退到传统的webdriver方式
